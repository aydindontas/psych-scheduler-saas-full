<!doctype html>
<html lang="tr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Psych Scheduler | Giriş</title>
<link rel="stylesheet" href="/static/style.css">

<body>
  <h1>Psych Scheduler</h1>
  <div>
    <label>E-posta</label><br>
    <input id="email" type="email" placeholder="ornek@domain.com" />
  </div>
  <div>
    <label>Şifre</label><br>
    <input id="pass" type="password" placeholder="en az 6 karakter" />
  </div>
  <button id="go">Giriş yap</button>

  <script>
    const $ = (id) => document.getElementById(id);

    async function post(url, body) {
      return fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
    }

    $("go").onclick = async () => {
      const email = $("email").value.trim().toLowerCase();
      const password = $("pass").value;

      if (!email || !password) { alert("E-posta ve şifre girin"); return; }

      // 1) login dene
      let r = await post("/api/auth/login", { email, password });

      // 2) 401 ise aynı bilgilerle signup dene (backend mevcut kullanıcıya da token döndürebiliyor)
      if (r.status === 401) {
        r = await post("/api/auth/signup", { email, password, clinic: "Klinik" });
      }

      if (!r.ok) {
        const msg = await r.text().catch(()=> "");
        alert("Giriş/Kayıt başarısız.\n" + msg);
        return;
      }

      // 3) token'ı sakla ve /schedule'a git
      const data = await r.json();
      localStorage.setItem("token", data.access_token);
      localStorage.setItem("tenant_key", data.tenant_key);
      location.href = "/schedule";
    };
  </script>
</body>
</html>
