<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Psych Scheduler | Giriş</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container" style="max-width:420px;margin-top:80px">
    <h1 class="center">Psych Scheduler</h1>
    <p class="helper center">Paneline erişmek için giriş yap.</p>

    <form id="login-form" class="card" style="margin-top:24px">
      <label for="li-email">E-posta</label>
      <input id="li-email" name="email" type="email" placeholder="ornek@domain.com" required />

      <label for="li-password">Şifre</label>
      <input id="li-password" name="password" type="password" placeholder="en az 6 karakter" minlength="6" required />

      <button type="submit" class="btn block" style="margin-top:18px">Giriş yap</button>
    </form>

    <p id="login-status" class="helper center" style="min-height:24px;margin-top:16px"></p>

    <p class="center" style="margin-top:12px">
      Hesabın yok mu? <a href="/static/signup.html">Kayıt ol</a>
    </p>
  </div>

  <script>
  (function () {
    // Zaten giriş yaptıysa panele yönlendir
    if (localStorage.getItem("token")) {
      window.location.href = "/schedule";
      return;
    }

    const $ = (s) => document.querySelector(s);
    const loginForm = $("#login-form");
    const statusEl  = $("#login-status");

    const setStatus = (msg, isError = false) => {
      if (!statusEl) return;
      statusEl.textContent = msg || "";
      statusEl.classList.toggle("err", !!isError);
    };

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatus("Giriş yapılıyor...");

      const email = $("#li-email").value.trim().toLowerCase();
      const password = $("#li-password").value;

      try {
        const r = await fetch("/api/auth/login", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ email, password })
        });

        if (!r.ok) {
          // API ayrıntılı mesaj döndürüyor olabilir
          let msg = "Geçersiz bilgiler";
          try {
            const err = await r.json();
            msg = err.detail || msg;
          } catch {}
          throw new Error(msg);
        }

        const data = await r.json();
        localStorage.setItem("token", data.access_token);
        localStorage.setItem("tenant_key", data.tenant_key);
        window.location.href = "/schedule"; // /schedule route’u static/schedule.html'i döndürüyor
      } catch (err) {
        setStatus("Giriş hatası: " + (err.message || err), true);
        alert("Giriş hatası: " + (err.message || err));
      }
    });
  })();
  </script>
</body>
</html>
