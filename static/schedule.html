<!doctype html>
<html lang="tr">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Randevu Planla</title>
<link rel="stylesheet" href="/static/style.css">

<body>
  <h2>Randevu Planla</h2>

  <div>
    <label>Danışan Telefonu (WhatsApp):</label><br>
    <input id="phone" placeholder="+9053xxxxxxx" />
  </div>

  <div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap">
    <div>
      <label>Tarih</label><br>
      <input id="date" type="date" />
    </div>
    <div>
      <label>Saat</label><br>
      <input id="time" type="time" />
    </div>
    <div>
      <label>Süre (dk)</label><br>
      <input id="duration" type="number" value="60" min="15" step="15" />
    </div>
    <button id="create">Randevu Oluştur</button>
  </div>

  <hr>

  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>Yaklaşan Randevular</h3>
    <button id="refresh">Yenile</button>
  </div>
  <table border="1" cellpadding="6" cellspacing="0">
    <thead><tr><th>ID</th><th>Telefon</th><th>Başlangıç</th><th>Bitiş</th><th>Durum</th><th>Kaynak</th></tr></thead>
    <tbody id="rows"><tr><td colspan="6">Yükleniyor...</td></tr></tbody>
  </table>

  <p><a id="logout" href="#">Çıkış yap</a></p>

  <script>
    const token = localStorage.getItem("token");
    if (!token) location.href = "/";

    const $ = (id) => document.getElementById(id);

    function isoLocal(dateStr, timeStr) {
      // YYYY-MM-DD + HH:MM → ISO (timezone belirtmeden gönderiyoruz, backend yerel TZ kabul edecek)
      return `${dateStr}T${timeStr}`;
    }

    async function api(path, opts={}) {
      const r = await fetch(path, {
        ...opts,
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token,
          ...(opts.headers || {})
        }
      });
      if (!r.ok) {
        const t = await r.text().catch(()=> "");
        throw new Error(`${r.status} ${r.statusText}\n${t}`);
      }
      return r.json();
    }

    async function loadUpcoming() {
      try {
        const data = await api("/api/appointments/upcoming");
        const tbody = $("rows");
        if (!data.length) {
          tbody.innerHTML = `<tr><td colspan="6">Kayıt yok</td></tr>`;
          return;
        }
        tbody.innerHTML = data.map(a => `
          <tr>
            <td>${a.id}</td>
            <td>${a.phone || "-"}</td>
            <td>${new Date(a.start).toLocaleString()}</td>
            <td>${new Date(a.end).toLocaleString()}</td>
            <td>${a.status}</td>
            <td>${a.source}</td>
          </tr>
        `).join("");
      } catch (e) {
        $("rows").innerHTML = `<tr><td colspan="6">Hata: ${e.message.replaceAll("<","&lt;")}</td></tr>`;
      }
    }

    $("refresh").onclick = loadUpcoming;

    $("create").onclick = async () => {
      const phone = $("phone").value.trim();
      const d = $("date").value;
      const t = $("time").value;
      const duration = parseInt($("duration").value || "60", 10);

      if (!phone || !d || !t) { alert("Telefon, tarih ve saat gerekli"); return; }

      const body = {
        phone,
        // server yerel TZ (ENV’deki Europe/Istanbul) kabul edip UTC’ye çevirecek
        start: isoLocal(d, t),
        // end göndermiyoruz → backend duration/slot_minutes ile hesaplıyor
      };

      try {
        await api("/api/appointments", { method: "POST", body: JSON.stringify(body) });
        alert("Randevu oluşturuldu!");
        loadUpcoming();
      } catch (e) {
        alert("Randevu oluşturulamadı:\n" + e.message);
      }
    };

    $("logout").onclick = (e) => {
      e.preventDefault();
      localStorage.removeItem("token");
      localStorage.removeItem("tenant_key");
      location.href = "/";
    };

    // sayfa açılışında listeyi getir
    loadUpcoming();
  </script>
</body>
</html>
